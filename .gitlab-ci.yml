# GitLab CI/CD конфигурация для Yandex Cloud
# Автоматический деплой AI Call Center

stages:
  - build
  - deploy

variables:
  # Yandex Container Registry
  YC_REGISTRY: cr.yandex/${YC_REGISTRY_ID}
  IMAGE_NAME: ai-call-center
  
  # Docker
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Сборка Docker образа
build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    # Установка Yandex Cloud CLI
    - apk add --no-cache python3 py3-pip curl
    - curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
    - export PATH="/root/yandex-cloud/bin:$PATH"
    
    # Авторизация в Yandex Cloud
    - echo "$YC_SERVICE_ACCOUNT_KEY" | yc config profile create ci-profile
    - yc config set service-account-key <(echo "$YC_SERVICE_ACCOUNT_KEY")
    - yc config set cloud-id $YC_CLOUD_ID
    - yc config set folder-id $YC_FOLDER_ID
    
    # Авторизация в Container Registry
    - yc container registry configure-docker
    
  script:
    # Сборка образа
    - docker build -t $YC_REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHA -f Dockerfile .
    - docker tag $YC_REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHA $YC_REGISTRY/$IMAGE_NAME:latest
    
    # Push в Yandex Container Registry
    - docker push $YC_REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHA
    - docker push $YC_REGISTRY/$IMAGE_NAME:latest
    
  only:
    - main

# Деплой на Yandex Compute Cloud VM
deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    # Установка необходимых утилит
    - apk add --no-cache openssh-client curl python3 py3-pip
    - curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
    - export PATH="/root/yandex-cloud/bin:$PATH"
    
    # Настройка SSH
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $VM_IP >> ~/.ssh/known_hosts
    
    # Авторизация в Yandex Cloud
    - yc config set service-account-key <(echo "$YC_SERVICE_ACCOUNT_KEY")
    - yc config set cloud-id $YC_CLOUD_ID
    - yc config set folder-id $YC_FOLDER_ID
    
  script:
    # Деплой через SSH
    - |
      ssh ubuntu@$VM_IP << 'ENDSSH'
        # Логин в Container Registry
        echo "$YC_SERVICE_ACCOUNT_KEY" | docker login \
          --username json_key \
          --password-stdin \
          cr.yandex
        
        # Переход в директорию проекта
        cd /opt/ai-call-center
        
        # Обновление образа в docker-compose
        export YC_REGISTRY="${YC_REGISTRY}"
        export IMAGE_NAME="${IMAGE_NAME}"
        export IMAGE_TAG="${CI_COMMIT_SHA}"
        
        # Загрузка нового образа
        docker-compose pull
        
        # Перезапуск контейнеров
        docker-compose up -d
        
        # Очистка старых образов
        docker image prune -f
      ENDSSH
    
  only:
    - main
  when: manual  # Ручной запуск деплоя (можно убрать для автоматического)

# Проверка здоровья после деплоя
health_check:
  stage: deploy
  image: curlimages/curl:latest
  script:
    - sleep 30  # Ждем запуска
    - curl -f http://$VM_IP:8000/health || exit 1
  only:
    - main
  needs:
    - deploy

